#!/bin/bash

set -e

head="${1:-HEAD}"

for sha in `git rev-list -n 100 --first-parent "$head"^`; do
  previous_tag="$(git tag -l --points-at "$sha" 'v*' 2>/dev/null || true)"
  [ -z "$previous_tag" ] || break
done

if [ -z "$previous_tag" ]; then
  echo "Couldn't detect previous version tag" >&2
  exit 1
fi

git log --no-merges \
  --format='%s%n%w(0,2,2)%+b' \
  --reverse "${previous_tag}..${head}" | \
  # trim release messages
  grep -Ev "^[0-9]+\.[0-9]+\.[0-9]+[^ ]*$" | \
  # squeeze multiple newlines
  cat -s | \
  # capitalize each commit msg
  sed 's/^\(.\)/\U\1/' | \
  # add * to each commit msg
  sed -e '1~2s/^/* /'
